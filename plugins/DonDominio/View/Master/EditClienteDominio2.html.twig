{#
/**
 * Vista personalizada para EditClienteDonDominio con selector de dominios
 */
#}
{% extends "Master/EditListView.html.twig" %}

{% block modals %}
    {{ parent() }}

    {# Modal para seleccionar dominio desde DonDominio #}
    <div class="modal fade" id="addDomainModal" tabindex="-1" aria-labelledby="addDomainModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" enctype="multipart/form-data" onsubmit="animateSpinner('add')">
                    {{ formToken() }}
                    <input type="hidden" name="action" value="dondominio-add-domain"/>
                    <input type="hidden" name="activetab" value="{{ currentView.getViewName() }}"/>
                    <div class="modal-header">
                        <h5 class="modal-title" id="addDomainModalLabel">
                            <i class="fa-solid fa-plus fa-fw"></i> {{ trans('dondominio-add-domain') }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="selected_domain" class="form-label">{{ trans('dondominio-select-domain') }}</label>
                            <select name="selected_domain" id="selected_domain" class="form-select" required>
                                <option value="">{{ trans('select') }}</option>
                                {% set availableDomains = fsc.getAvailableDomains() %}
                                {% for code, option in availableDomains %}
                                    {% set optionLabel = option.label ?? code %}
                                    <option value="{{ code }}">{{ optionLabel }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">{{ trans('dondominio-select-domain-help') }}</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fa-solid fa-times"></i> {{ trans('cancel') }}
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-check"></i> {{ trans('add') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="authcodeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-key me-2"></i>{{ trans('dondominio-authcode-modal-title') }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ trans('close') }}"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">{{ trans('dondominio-authcode-modal-description') }}</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="dondominioAuthcodeValue" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="dondominioAuthcodeCopy">{{ trans('copy') }}</button>
                    </div>
                    <div class="alert alert-danger d-none mt-3" id="dondominioAuthcodeAlert" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ trans('close') }}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="dondominioDnsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <form class="modal-content" id="dondominioDnsForm">
                {{ formToken() }}
                <input type="hidden" name="action" value="dondominio-domain-update-nameservers"/>
                <input type="hidden" name="activetab" value="{{ currentView.getViewName() }}"/>
                <input type="hidden" name="code" id="dondominioDnsLocalId"/>
                <input type="hidden" name="domain_name" id="dondominioDnsDomainName"/>
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-server me-2"></i>{{ trans('dondominio-dns-modal-title') }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ trans('close') }}"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">
                        {{ trans('dondominio-dns-modal-description') }}
                        <strong id="dondominioDnsDomain" class="ms-2"></strong>
                    </p>
                    <div class="alert alert-danger d-none" id="dondominioDnsAlert"></div>
                    <div id="dondominioDnsInputs" class="vstack gap-2 mb-2"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="dondominioDnsAdd">
                        <i class="fa-solid fa-plus me-1"></i>{{ trans('add') }}
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ trans('close') }}</button>
                    <button type="submit" class="btn btn-primary">{{ trans('save') }}</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function () {
            if (window.DonDominioDomains && window.DonDominioDomains.__initialized) {
                return;
            }

            const hasBootstrap = typeof bootstrap !== 'undefined';
            const genericError = '{{ trans('dondominio-generic-error')|e('js') }}';
            const confirmEnableText = '{{ trans('dondominio-transfer-lock-confirm-enable')|e('js') }}';
            const confirmDisableText = '{{ trans('dondominio-transfer-lock-confirm-disable')|e('js') }}';

            const randomToken = () => {
                const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            };

            const refreshToken = (input) => {
                if (!input) {
                    return '';
                }
                const value = input.value || '';
                if (value.includes('|')) {
                    const [prefix] = value.split('|');
                    const token = prefix + '|' + randomToken();
                    input.value = token;
                    return token;
                }
                const token = value ? value + '|' + randomToken() : randomToken();
                input.value = token;
                return token;
            };

            const buildFormData = (form, action, extra = {}) => {
                const formData = new FormData();
                formData.append('action', action);

                const codeInput = form.querySelector('input[name="code"]');
                if (codeInput) {
                    formData.append('code', codeInput.value);
                    formData.append('domainId', codeInput.value);
                }

                const domainNameInput = form.querySelector('input[name="domain_name"]');
                if (domainNameInput) {
                    formData.append('domain_name', domainNameInput.value);
                }

                const tabInput = form.querySelector('input[name="activetab"]');
                if (tabInput) {
                    formData.append('activetab', tabInput.value);
                }

                const tokenInput = form.querySelector('input[name="multireqtoken"]');
                if (tokenInput) {
                    formData.append('multireqtoken', refreshToken(tokenInput));
                }

                Object.entries(extra).forEach(([key, value]) => {
                    if (Array.isArray(value)) {
                        value.forEach((item) => formData.append(key, item));
                    } else if (value !== undefined && value !== null) {
                        formData.append(key, value);
                    }
                });
                return formData;
            };

            const postAction = async (form, action, extra = {}) => {
                const formData = buildFormData(form, action, extra);
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                const contentType = response.headers.get('Content-Type') || '';
                if (contentType.indexOf('application/json') !== -1) {
                    return response.json();
                }

                return {
                    success: response.ok,
                    message: response.ok ? '' : 'HTTP ' + response.status
                };
            };

            const authModalEl = document.getElementById('authcodeModal');
            const authModal = authModalEl && hasBootstrap ? new bootstrap.Modal(authModalEl) : null;
            const authValue = document.getElementById('dondominioAuthcodeValue');
            const authAlert = document.getElementById('dondominioAuthcodeAlert');
            const authCopy = document.getElementById('dondominioAuthcodeCopy');
            const dnsModalEl = document.getElementById('dondominioDnsModal');
            const dnsModal = dnsModalEl && hasBootstrap ? new bootstrap.Modal(dnsModalEl) : null;
            const dnsForm = document.getElementById('dondominioDnsForm');
            const dnsInputs = document.getElementById('dondominioDnsInputs');
            const dnsAlert = document.getElementById('dondominioDnsAlert');
            const dnsDomainLabel = document.getElementById('dondominioDnsDomain');
            const dnsDomainNameInput = document.getElementById('dondominioDnsDomainName');
            const dnsLocalIdInput = document.getElementById('dondominioDnsLocalId');
            const dnsAddButton = document.getElementById('dondominioDnsAdd');
            const DNS_MAX_INPUTS = 7;

            const showAuthAlert = (message) => {
                if (!authAlert) {
                    return;
                }
                authAlert.textContent = message || genericError;
                authAlert.classList.remove('d-none');
            };

            const clearAuthAlert = () => {
                if (!authAlert) {
                    return;
                }
                authAlert.textContent = '';
                authAlert.classList.add('d-none');
            };

            const clearDnsAlert = () => {
                if (!dnsAlert) {
                    return;
                }
                dnsAlert.classList.add('d-none');
                dnsAlert.classList.remove('alert-danger', 'alert-success');
                dnsAlert.textContent = '';
            };

            const showDnsAlert = (message, type = 'danger') => {
                if (!dnsAlert) {
                    return;
                }
                dnsAlert.textContent = message || genericError;
                dnsAlert.classList.remove('d-none', 'alert-danger', 'alert-success');
                dnsAlert.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
            };

            const addDnsInput = (value = '') => {
                if (!dnsInputs) {
                    return;
                }
                const count = dnsInputs.querySelectorAll('input[name="nameservers[]"]').length;
                if (count >= DNS_MAX_INPUTS) {
                    return;
                }
                const wrapper = document.createElement('div');
                wrapper.className = 'input-group';
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'nameservers[]';
                input.className = 'form-control';
                input.placeholder = 'ns' + (count + 1) + '.example.com';
                input.value = value || '';
                wrapper.appendChild(input);
                dnsInputs.appendChild(wrapper);
            };

            const renderDnsInputs = (values) => {
                if (!dnsInputs) {
                    return;
                }
                dnsInputs.innerHTML = '';
                const base = Array.isArray(values) && values.length > 0 ? values : ['', ''];
                base.slice(0, DNS_MAX_INPUTS).forEach((value) => addDnsInput(value));
                while (dnsInputs.querySelectorAll('input[name="nameservers[]"]').length < 2) {
                    addDnsInput('');
                }
            };

            const initAddDomainModal = () => {
                const buttons = document.querySelectorAll('[data-action="dondominio-add-domain"]');
                buttons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        if (!hasBootstrap) {
                            return;
                        }
                        const modalElement = document.getElementById('addDomainModal');
                        if (modalElement) {
                            const modal = new bootstrap.Modal(modalElement);
                            modal.show();
                        }
                    });
                });
            };

            const toggleLoading = (button, loading) => {
                if (!button) {
                    return;
                }
                button.disabled = loading;
                button.classList.toggle('disabled', loading);
            };

            window.DonDominioDomains = {
                requestAuthCode(button) {
                    const form = button?.closest('form');
                    if (!form || !authModal) {
                        return false;
                    }

                    toggleLoading(button, true);
                    clearAuthAlert();
                    if (authValue) {
                        authValue.value = '';
                    }
                    authModal.show();

                    postAction(form, '{{ constant('FacturaScripts\\Plugins\\DonDominio\\Controller\\EditCliente::ACTION_DOMAIN_AUTHCODE')|default('get-domain-authcode') }}')
                        .then((result) => {
                            if (result && result.success) {
                                if (authValue) {
                                    authValue.value = result.code || '';
                                    authValue.focus();
                                    authValue.select();
                                }
                            } else {
                                showAuthAlert(result?.message || genericError);
                            }
                        })
                        .catch(() => showAuthAlert(genericError))
                        .finally(() => toggleLoading(button, false));
                    return false;
                },

                editDns(button) {
                    if (!dnsModal) {
                        return false;
                    }

                    const form = button?.closest('form');
                    if (!form) {
                        return false;
                    }

                    toggleLoading(button, true);
                    clearDnsAlert();

                    const domainNameInput = form.querySelector('input[name="domain_name"]');
                    const domainName = domainNameInput ? domainNameInput.value : '';
                    const resolvedDomain = domainName || button.dataset.domainLabel || '';
                    const localIdInput = form.querySelector('input[name="code"]');
                    const localId = localIdInput ? localIdInput.value : '';
                    const domainLabel = button.dataset.domainLabel || domainName;

                    const extra = { domain_name: resolvedDomain };
                    if (localId) {
                        extra.domain_id = localId;
                    }

                    postAction(form, '{{ constant('FacturaScripts\\Plugins\\DonDominio\\Controller\\EditCliente::ACTION_DOMAIN_GET_NAMESERVERS')|default('dondominio-domain-get-nameservers') }}', extra)
                        .then((result) => {
                            if (!result || !result.success) {
                                showDnsAlert(result?.message || genericError);
                                return;
                            }

                            if (dnsDomainLabel) {
                                dnsDomainLabel.textContent = result.domain || domainLabel;
                            }
                            if (dnsDomainNameInput) {
                                dnsDomainNameInput.value = resolvedDomain;
                            }
                            if (dnsLocalIdInput) {
                                dnsLocalIdInput.value = localId;
                            }
                            if (dnsForm) {
                                const tokenInput = dnsForm.querySelector('input[name="multireqtoken"]');
                                if (tokenInput) {
                                    refreshToken(tokenInput);
                                }
                            }

                            renderDnsInputs(result.nameservers || []);
                            dnsModal.show();
                        })
                        .catch(() => showDnsAlert(genericError))
                        .finally(() => toggleLoading(button, false));

                    return false;
                },

                submitDnsForm(event) {
                    if (event) {
                        event.preventDefault();
                    }

                    if (!dnsForm) {
                        return false;
                    }

                    clearDnsAlert();

                    const nameservers = Array.from(dnsInputs?.querySelectorAll('input[name="nameservers[]"]') || [])
                        .map((input) => input.value.trim())
                        .filter((value) => value !== '');

                    if (nameservers.length < 2) {
                        showDnsAlert('{{ trans('dondominio-dns-error-too-few')|e('js') }}');
                        return false;
                    }

                    const tokenInput = dnsForm.querySelector('input[name="multireqtoken"]');
                    const tokenValue = tokenInput ? refreshToken(tokenInput) : '';

                    const formData = new FormData();
                    formData.append('action', '{{ constant('FacturaScripts\\Plugins\\DonDominio\\Controller\\EditCliente::ACTION_DOMAIN_UPDATE_NAMESERVERS')|default('dondominio-domain-update-nameservers') }}');

                    const tabInput = dnsForm.querySelector('input[name="activetab"]');
                    if (tabInput) {
                        formData.append('activetab', tabInput.value);
                    }

                    if (dnsLocalIdInput && dnsLocalIdInput.value) {
                        formData.append('code', dnsLocalIdInput.value);
                        formData.append('domain_id', dnsLocalIdInput.value);
                        formData.append('domainId', dnsLocalIdInput.value);
                    }

                    if (dnsDomainNameInput) {
                        formData.append('domain_name', dnsDomainNameInput.value);
                    }

                    if (tokenValue) {
                        formData.append('multireqtoken', tokenValue);
                    }

                    nameservers.forEach((value) => formData.append('nameservers[]', value));

                    fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    })
                        .then((response) => response.json())
                        .then((result) => {
                            if (!result || !result.success) {
                                showDnsAlert(result?.message || genericError);
                                return;
                            }
                            showDnsAlert(result.message || genericError, 'success');
                        })
                        .catch(() => showDnsAlert(genericError));

                    return false;
                },

                toggleTransferLock(button) {
                    const form = button?.closest('form');
                    if (!form) {
                        return false;
                    }

                    toggleLoading(button, true);

                    postAction(form, '{{ constant('FacturaScripts\\Plugins\\DonDominio\\Controller\\EditCliente::ACTION_DOMAIN_TRANSFER_LOCK_STATUS')|default('get-domain-transfer-lock') }}')
                        .then(async (statusResult) => {
                            if (!statusResult || !statusResult.success) {
                                window.alert((statusResult && statusResult.message) || genericError);
                                return;
                            }

                            const currentlyEnabled = !!statusResult.enabled;
                            const confirmText = currentlyEnabled ? confirmDisableText : confirmEnableText;
                            if (confirmText && !window.confirm(confirmText)) {
                                return;
                            }

                            const updateResult = await postAction(
                                form,
                                '{{ constant('FacturaScripts\\Plugins\\DonDominio\\Controller\\EditCliente::ACTION_DOMAIN_TRANSFER_LOCK_UPDATE')|default('update-domain-transfer-lock') }}',
                                { lock: currentlyEnabled ? '0' : '1' }
                            );

                            if (!updateResult || !updateResult.success) {
                                window.alert((updateResult && updateResult.message) || genericError);
                                return;
                            }

                            if (updateResult.message) {
                                window.alert(updateResult.message);
                            }
                        })
                        .catch(() => window.alert(genericError))
                        .finally(() => toggleLoading(button, false));

                    return false;
                },

                __initialized: true
            };

            if (authCopy && navigator.clipboard) {
                authCopy.addEventListener('click', async () => {
                    if (!authValue || !authValue.value) {
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(authValue.value);
                        authCopy.classList.add('btn-success');
                        setTimeout(() => authCopy.classList.remove('btn-success'), 1200);
                    } catch (error) {
                        console.error('Clipboard error', error);
                        showAuthAlert(genericError);
                    }
                });
            }

            initAddDomainModal();

            if (dnsAddButton) {
                dnsAddButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    addDnsInput('');
                });
            }

            if (dnsForm) {
                dnsForm.addEventListener('submit', (event) => DonDominioDomains.submitDnsForm(event));
            }

            renderDnsInputs([]);
        })();
    </script>
{% endblock %}


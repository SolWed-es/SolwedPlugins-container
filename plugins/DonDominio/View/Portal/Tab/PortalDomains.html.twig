{% set error_message = view.error_message %}
{% set has_error = error_message is not empty %}

{% if has_error %}
    <div class="alert alert-{{ view.error_type|default('warning') }} d-flex align-items-center" role="alert">
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        {{ error_message }}
    </div>
{% endif %}

{% if view.count == 0 or view.cursor is empty %}
    <div class="alert alert-info d-flex align-items-center">
        <i class="fa-solid fa-info-circle me-2"></i>
        No hay dominios registrados para este cliente.
    </div>
{% else %}
    {# Dominios próximos a expirar #}
    {% if view.expiring_count > 0 %}
        <div class="alert alert-warning mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="fa-solid fa-clock me-2"></i>
                <strong>Dominios próximos a expirar</strong>
            </div>
            <p class="mb-2 mt-2">Tienes {{ view.expiring_count }} dominio(s) próximo(s) a expirar en los próximos 30 días.</p>
            {% if view.expiring_domains is not empty %}
                <ul class="mb-0 ps-4">
                    {% for domain in view.expiring_domains %}
                        <li class="small">
                            <strong>{{ domain.name }}</strong>
                            expira el
                            <code>{{ domain.expiration }}</code>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    {% endif %}

    {# Tabla de dominios #}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">
                        <i class="fa-solid fa-globe me-1"></i>Dominio
                    </th>
                    <th scope="col">
                        <i class="fa-solid fa-circle-notch me-1"></i>Estado
                    </th>
                    <th scope="col">
                        <i class="fa-solid fa-calendar me-1"></i>Expira
                    </th>
                    <th scope="col">
                        <i class="fa-solid fa-rotate me-1"></i>Renovación automática
                    </th>
                    <th scope="col" class="text-end">
                        <i class="fa-solid fa-toolbox me-1"></i>Herramientas
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for contact in view.cursor %}
                    {% for domain in contact.domains %}
                        <tr>
                            <td>
                                <a href="https://{{ domain.name }}" target="_blank" rel="noopener noreferrer"
                                   class="text-decoration-none">
                                    <i class="fa-solid fa-arrow-up-right-from-square me-1"></i>
                                    {{ domain.name }}
                                </a>
                            </td>
                            <td>
                                {% set status_lower = (domain.status ?: 'unknown')|lower %}
                                {% if status_lower == 'active' %}
                                    <span class="badge bg-success">
                                        <i class="fa-solid fa-check me-1"></i>Activo
                                    </span>
                                {% elseif status_lower in ['inactive', 'expired', 'caducado', 'suspended', 'cancelado'] %}
                                    <span class="badge bg-danger">
                                        <i class="fa-solid fa-circle-xmark me-1"></i>{{ domain.status }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fa-solid fa-circle-exclamation me-1"></i>{{ domain.status }}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if domain.expiration %}
                                    {{ domain.expiration|slice(0, 10) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
            <td>
                {% if domain.autorenew %}
                    <span class="badge bg-success">
                        <i class="fa-solid fa-check me-1"></i>S&amp;iacute;
                    </span>
                {% else %}
                    <div class="d-grid gap-2">
                        <span class="badge bg-secondary text-dark">
                            <i class="fa-solid fa-ban me-1"></i>No
                        </span>
                        {% if not view.has_signed_domiciliation|default(false) %}
                        <small class="text-muted">
                            Para activar la renovaci&amp;oacute;n autom&amp;aacute;tica necesitamos el contrato firmado.
                            <a href="{{ view.autorenew_contract_url|default('https://filedn.eu/litOB0SUT8q5aLOM933djFm/Contrato%20domiciliaci&amp;oacute;n-Solwed.pdf') }}"
                               target="_blank" rel="noopener noreferrer">
                                Descarga aqu&amp;iacute; el documento.
                            </a>
                        </small>
                        {% endif %}
                    </div>
                {% endif %}
            </td>
                            <td class="text-end">
                                {% set nameservers = domain.nameservers ?? [] %}
                                {% set second_ns = nameservers[1] ?? null %}
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button"
                                            class="btn btn-outline-primary{% if not second_ns %} disabled{% endif %}"
                                            {% if not second_ns %}disabled{% endif %}
                                            data-second-ns="{{ second_ns }}"
                                            onclick="openSecondNameserver(this)"
                                            title="Abrir el segundo nameserver configurado">
                                        <i class="fa-solid fa-server me-1"></i>Servidor NS2
                                    </button>
                                    <a class="btn btn-outline-info"
                                       href="https://serverdata.solwed-hosting.es"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       title="Abrir el centro de correos de Solwed">
                                        <i class="fa-solid fa-envelope me-1"></i>Correos
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

{% endif %}

<script>

// Abrir segundo nameserver en nueva pestaña
function openSecondNameserver(button) {
    if (!button) {
        return;
    }

    const ns = (button.getAttribute('data-second-ns') || '').trim();

    if (!ns) {
        alert('Este dominio no tiene configurado un segundo nameserver.');
        return;
    }

    const url = /^https?:\/\//i.test(ns) ? ns : 'https://' + ns;
    window.open(url, '_blank', 'noopener');
}

// Helper para AJAX
function fetchAction(action, params, callback) {
    const formData = new FormData();
    formData.append('action', action);
    for (const key in params) {
        formData.append(key, params[key]);
    }

    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(callback)
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión');
    });
}
</script>

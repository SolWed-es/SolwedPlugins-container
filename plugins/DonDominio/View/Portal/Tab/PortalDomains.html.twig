{% set domains = fsc.domains %}

{% if domains is empty %}
    <div class="alert alert-info">
        <i class="fa-solid fa-info-circle me-1"></i>
        {{ trans('dondominio-no-domains') }}
    </div>
{% else %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle text-center">
            <thead class="table-light">
            <tr>
                <th scope="col"><i class="fa-solid fa-globe me-1"></i>{{ trans('dondominio-domain') }}</th>
                <th scope="col"><i class="fa-solid fa-circle-notch me-1"></i>{{ trans('dondominio-status') }}</th>
                <th scope="col"><i class="fa-solid fa-calendar me-1"></i>{{ trans('dondominio-expires-at') }}</th>
                <th scope="col"><i class="fa-solid fa-rotate me-1"></i>{{ trans('dondominio-autorenew') }}</th>
                <th scope="col"></th>
            </tr>
            </thead>
            <tbody>
            {% for domain in domains %}
                <tr>
                    <td>
                        {% if domain.domain %}
                            {% set url = 'https://' ~ domain.domain %}
                            <a href="{{ url }}" target="_blank" rel="noopener noreferrer">{{ domain.domain }}</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% set rawStatus = domain.status ?: '' %}
                        {% set normalizedStatus = rawStatus|lower %}
                        {% set statusClass = 'text-warning' %}
                        {% if normalizedStatus == 'active' %}
                            {% set statusClass = 'text-success' %}
                        {% elseif normalizedStatus in ['inactive', 'expired', 'caducado', 'cancelled', 'cancelado'] %}
                            {% set statusClass = 'text-danger' %}
                        {% endif %}
                        {% if rawStatus %}
                            <span class="{{ statusClass }}" title="{{ rawStatus }}">
                                <i class="fa-solid fa-circle"></i>
                                <span class="visually-hidden">{{ rawStatus }}</span>
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ domain.expires_at ?: '-' }}</td>
                    <td>
                        {% if domain.autorenew %}
                            <span class="badge bg-success">{{ trans('yes') }}</span>
                        {% else %}
                            <span class="badge bg-secondary me-2">{{ trans('no') }}</span>
                            <a href="#"
                               class="btn btn-sm btn-outline-warning d-inline-flex align-items-center download-autorenew-contract"
                               data-domain="{{ domain.id }}"
                               data-contact="{{ fsc.contact.idcontacto }}"
                               data-token="{{ formToken(false)|e('html_attr') }}">
                                <i class="fa-solid fa-file-arrow-down me-1"></i>
                                {{ trans('dondominio-autorenew-contract') }}
                            </a>
                        {% endif %}
                    </td>
                    <td></td>
                </tr>
                <tr class="domain-actions bg-dark text-light">
                    <td colspan="5" class="text-center py-4">
                        <div class="d-inline-flex flex-wrap justify-content-center gap-4">
                            {% if domain.domain %}
                                {% set whoisUrl = 'https://www.dondominio.com/whois/?domain=' ~ domain.domain %}
                                <a class="btn btn-sm btn-outline-info d-inline-flex align-items-center"
                                   href="{{ whoisUrl }}"
                                   target="_blank" rel="noopener">
                                    <i class="fa-solid fa-search me-1"></i>
                                    {{ trans('dondominio-whois') }}
                                </a>
                            {% endif %}
                            <a href="#"
                               class="btn btn-sm btn-outline-warning d-inline-flex align-items-center domain-transferlock-button"
                               data-domain="{{ domain.id }}"
                               data-contact="{{ fsc.contact.idcontacto }}"
                               data-confirm-enable="{{ trans('dondominio-transfer-lock-confirm-enable')|e('html_attr') }}"
                               data-confirm-disable="{{ trans('dondominio-transfer-lock-confirm-disable')|e('html_attr') }}"
                               data-enabled-label="{{ trans('dondominio-transfer-lock-enabled-label')|e('html_attr') }}"
                               data-disabled-label="{{ trans('dondominio-transfer-lock-disabled-label')|e('html_attr') }}"
                               data-token="{{ formToken(false)|e('html_attr') }}">
                                <i class="fa-solid fa-lock me-1"></i>
                                <span class="transfer-lock-label">{{ trans('dondominio-transfer-lock') }}</span>
                            </a>
                            <a href="#"
                               class="btn btn-sm btn-outline-primary d-inline-flex align-items-center domain-authcode-button"
                               data-domain="{{ domain.id }}"
                               data-contact="{{ fsc.contact.idcontacto }}"
                               data-token="{{ formToken(false)|e('html_attr') }}">
                                <i class="fa-solid fa-key me-1"></i>
                                {{ trans('dondominio-authcode') }}
                            </a>
                            <a class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center"
                               href="{{ domain.web_link|default('https://ns5.solwed-hosting.es') }}"
                               target="_blank" rel="noopener">
                                <i class="fa-solid fa-globe me-1"></i>
                                {{ trans('dondominio-web-server') }}
                            </a>
                            <a class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center"
                               href="{{ domain.mail_link|default('https://serverdata.solwed-hosting.es') }}"
                               target="_blank" rel="noopener">
                                <i class="fa-solid fa-envelope me-1"></i>
                                {{ trans('dondominio-mail-server') }}
                            </a>
                            {% set erpReady = domain.erp_action and domain.erp_user and domain.erp_pass %}
                            {% set erpFormId = 'erpAutoLoginForm-' ~ domain.id %}
                            <form id="{{ erpFormId }}" action="{{ domain.erp_action|default('') }}" method="post" target="_blank" class="d-inline">
                                <input type="hidden" name="{{ domain.erp_user_field|default('username') }}" value="{{ domain.erp_user|default('') }}">
                                <input type="hidden" name="{{ domain.erp_pass_field|default('password') }}" value="{{ domain.erp_pass|default('') }}">
                                <button type="submit" class="btn btn-sm d-inline-flex align-items-center"
                                        style="background-color:#f2e500;color:#1f1f1f;text-transform:uppercase;font-weight:600;"
                                        {% if not erpReady %}disabled title="{{ trans('dondominio-erp-missing') }}"{% endif %}>
                                    <i class="fa-solid fa-house-laptop me-1"></i>
                                    ERP
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <p class="text-muted small mb-0">
        <i class="fa-solid fa-circle-info me-1"></i>
        {{ trans('dondominio-help') }}
    </p>
    <div class="modal fade" id="dnsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <form class="modal-content" id="dnsForm" data-error-too-few="{{ trans('dondominio-dns-error-too-few')|e('html_attr') }}">
    <div class="modal fade" id="authcodeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fa-solid fa-key me-2"></i>{{ trans('dondominio-authcode-modal-title') }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ trans('close') }}"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">{{ trans('dondominio-authcode-modal-description') }}</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="authcodeValue" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="authcodeCopy">{{ trans('copy') }}</button>
                    </div>
                    <div class="alert alert-danger d-none mt-3" id="authcodeAlert" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ trans('close') }}</button>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
    (function () {
        if (window.__portalDomainsInitialized) {
            return;
        }
        window.__portalDomainsInitialized = true;

        const hasBootstrap = typeof bootstrap !== 'undefined';
        const genericError = '{{ trans('dondominio-generic-error')|e('js') }}';

        const randomToken = () => {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        const createToken = (element) => {
            if (!element) {
                return '';
            }
            const base = element.dataset.token || '';
            if (base.includes('|')) {
                const [prefix] = base.split('|');
                const token = prefix + '|' + randomToken();
                element.dataset.token = token;
                return token;
            }
            return base;
        };

        const parseFileName = (disposition, fallback) => {
            if (!disposition) {
                return fallback;
            }
            const match = disposition.match(/filename\\*=UTF-8''([^;]+)|filename=\"?([^\";]+)\"?/i);
            if (!match) {
                return fallback;
            }
            const encoded = match[1] || match[2];
            try {
                return decodeURIComponent(encoded);
            } catch (error) {
                return encoded;
            }
        };

        const setTransferLockStyle = (button, enabled) => {
            if (!button) {
                return;
            }

            button.dataset.lockState = enabled ? '1' : '0';
            button.classList.remove('btn-outline-warning', 'btn-outline-success', 'btn-outline-danger');
            button.classList.add(enabled ? 'btn-outline-danger' : 'btn-outline-success');

            const icon = button.querySelector('i');
            if (icon) {
                icon.classList.remove('fa-lock', 'fa-lock-open');
                icon.classList.add(enabled ? 'fa-lock' : 'fa-lock-open');
            }

            const label = button.querySelector('.transfer-lock-label');
            if (label) {
                const text = enabled ?
                    (button.dataset.enabledLabel || label.textContent) :
                    (button.dataset.disabledLabel || label.textContent);
                label.textContent = text;
            } else {
                button.innerText = enabled ?
                    (button.dataset.enabledLabel || button.innerText) :
                    (button.dataset.disabledLabel || button.innerText);
            }
        };

        const fetchTransferLockState = async (button) => {
            const formData = new FormData();
            formData.append('action', 'get-domain-transfer-lock');
            formData.append('idcontacto', button.dataset.contact);
            formData.append('domainId', button.dataset.domain);
            formData.append('multireqtoken', createToken(button));

            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }

            return response.json();
        };

        const updateTransferLock = async (button, lockValue) => {
            const formData = new FormData();
            formData.append('action', 'update-domain-transfer-lock');
            formData.append('idcontacto', button.dataset.contact);
            formData.append('domainId', button.dataset.domain);
            formData.append('lock', lockValue);
            formData.append('multireqtoken', createToken(button));

            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }

            return response.json();
        };

        const disableLink = (element) => {
            if (!element) {
                return;
            }
            element.classList.add('disabled');
            element.setAttribute('aria-disabled', 'true');
        };

        const enableLink = (element) => {
            if (!element) {
                return;
            }
            element.classList.remove('disabled');
            element.removeAttribute('aria-disabled');
        };

        // Auto-renovaciÃ³n: descarga del contrato
        document.querySelectorAll('.download-autorenew-contract').forEach((button) => {
            button.addEventListener('click', async (event) => {
                event.preventDefault();
                if (button.dataset.loading === '1') {
                    return;
                }

                button.dataset.loading = '1';
                disableLink(button);

                const formData = new FormData();
                formData.append('action', 'download-autorenew-contract');
                formData.append('idcontacto', button.dataset.contact);
                formData.append('domainId', button.dataset.domain);
                formData.append('multireqtoken', createToken(button));

                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }

                    const blob = await response.blob();
                    if (blob.size === 0) {
                        throw new Error('Empty response');
                    }

                    const filename = parseFileName(
                        response.headers.get('Content-Disposition'),
                        'Contrato_domiciliacion_Solwed.pdf'
                    );

                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.setTimeout(() => window.URL.revokeObjectURL(url), 2000);
                } catch (error) {
                    console.error('Contract download failed:', error);
                } finally {
                    button.dataset.loading = '0';
                    enableLink(button);
                }
            });
        });

        // Auth-code
        const authModalEl = document.getElementById('authcodeModal');
        const authModal = authModalEl && hasBootstrap ? new bootstrap.Modal(authModalEl) : null;
        const authCodeValue = document.getElementById('authcodeValue');
        const authCodeAlert = document.getElementById('authcodeAlert');
        const authCodeCopy = document.getElementById('authcodeCopy');
        let activeAuthButton = null;

        const clearAuthAlert = () => {
            if (!authCodeAlert) {
                return;
            }
            authCodeAlert.classList.add('d-none');
            authCodeAlert.textContent = '';
        };

        const showAuthAlert = (message) => {
            if (!authCodeAlert) {
                return;
            }
            authCodeAlert.textContent = message || genericError;
            authCodeAlert.classList.remove('d-none');
        };

        document.querySelectorAll('.domain-authcode-button').forEach((button) => {
            button.addEventListener('click', async (event) => {
                event.preventDefault();
                if (!authModal || button.dataset.loading === '1') {
                    return;
                }

                button.dataset.loading = '1';
                disableLink(button);
                activeAuthButton = button;

                clearAuthAlert();
                if (authCodeValue) {
                    authCodeValue.value = '';
                }

                authModal.show();

                const formData = new FormData();
                formData.append('action', 'get-domain-authcode');
                formData.append('idcontacto', button.dataset.contact);
                formData.append('domainId', button.dataset.domain);
                formData.append('multireqtoken', createToken(button));

                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    });

                    const result = await response.json();
                    if (result.success) {
                        if (authCodeValue) {
                            authCodeValue.value = result.code || '';
                            authCodeValue.focus();
                            authCodeValue.select();
                        }
                    } else {
                        showAuthAlert(result.message);
                    }
                } catch (error) {
                    console.error('Auth-code fetch failed:', error);
                    showAuthAlert(genericError);
                } finally {
                    button.dataset.loading = '0';
                    enableLink(button);
                }
            });
        });

        if (authCodeCopy) {
            authCodeCopy.addEventListener('click', async () => {
                if (!authCodeValue || !authCodeValue.value) {
                    return;
                }
                try {
                    await navigator.clipboard.writeText(authCodeValue.value);
                    authCodeCopy.classList.add('btn-success');
                    setTimeout(() => authCodeCopy.classList.remove('btn-success'), 1200);
                } catch (error) {
                    console.error('Clipboard copy failed:', error);
                    showAuthAlert(genericError);
                }
            });
        }

        // DNS
        // Transfer lock
        document.querySelectorAll('.domain-transferlock-button').forEach((button) => {
            (async () => {
                button.dataset.loading = '1';
                disableLink(button);
                try {
                    const result = await fetchTransferLockState(button);
                    if (result && result.success) {
                        if (result.enabledMessage) {
                            button.dataset.enabledLabel = result.enabledMessage;
                        }
                        if (result.disabledMessage) {
                            button.dataset.disabledLabel = result.disabledMessage;
                        }
                        setTransferLockStyle(button, !!result.enabled);
                    }
                } catch (error) {
                    console.error('Transfer lock state load failed:', error);
                } finally {
                    button.dataset.loading = '0';
                    enableLink(button);
                }
            })();

            button.addEventListener('click', async (event) => {
                event.preventDefault();
                if (button.dataset.loading === '1') {
                    return;
                }

                button.dataset.loading = '1';
                disableLink(button);

                try {
                    const status = await fetchTransferLockState(button);
                    if (!status || !status.success) {
                        window.alert((status && status.message) || genericError);
                        return;
                    }

                    const currentlyEnabled = !!status.enabled;
                    if (status.enabledMessage) {
                        button.dataset.enabledLabel = status.enabledMessage;
                    }
                    if (status.disabledMessage) {
                        button.dataset.disabledLabel = status.disabledMessage;
                    }
                    setTransferLockStyle(button, currentlyEnabled);

                    const confirmText = currentlyEnabled ?
                        (button.dataset.confirmDisable || '') :
                        (button.dataset.confirmEnable || '');

                    if (confirmText && !window.confirm(confirmText)) {
                        return;
                    }

                    const updateResult = await updateTransferLock(button, currentlyEnabled ? '0' : '1');
                    if (!updateResult || !updateResult.success) {
                        window.alert((updateResult && updateResult.message) || genericError);
                        return;
                    }

                    if (typeof updateResult.enabledLabel === 'string') {
                        button.dataset.enabledLabel = updateResult.enabledLabel;
                    }
                    if (typeof updateResult.disabledLabel === 'string') {
                        button.dataset.disabledLabel = updateResult.disabledLabel;
                    }

                    setTransferLockStyle(button, !!updateResult.enabled);
                    if (updateResult.message) {
                        window.alert(updateResult.message);
                    }
                } catch (error) {
                    console.error('Transfer lock update failed:', error);
                    window.alert(genericError);
                } finally {
                    button.dataset.loading = '0';
                    enableLink(button);
                }
            });
        });
    })();
</script>

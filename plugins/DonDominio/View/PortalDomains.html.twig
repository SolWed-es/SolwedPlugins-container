{% set error_message = view.error_message %}
{% set has_error = error_message is not empty %}
{% set allow_autorenew_toggle = view.allow_autorenew_toggle|default(false) %}

{# Panel de saldo de cuenta (solo administradores) #}
{% if view.account_info is defined and view.account_info is not empty %}
<div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
    <div>
        <i class="fa-solid fa-wallet me-2"></i>
        <strong>Cuenta DonDominio:</strong> {{ view.account_info.account_name }}
    </div>
    <div>
        <span class="badge bg-primary fs-6">
            Saldo disponible: {{ view.account_info.balance|number_format(2, ',', '.') }} {{ view.account_info.currency }}
        </span>
    </div>
</div>
{% endif %}

{# Información sobre autorenovación - Se muestra cuando el usuario no puede activar renovación automática #}
{% if not view.allow_autorenew_toggle|default(true) %}
<div class="alert alert-secondary d-flex align-items-center justify-content-between mb-3" role="alert">
    <div class="me-3">
        <i class="fa-solid fa-file-signature me-2"></i>
        Si necesitas activar la renovación automática de un dominio, descarga y firma el contrato de domiciliación.
    </div>
    <a href="{{ view.autorenew_contract_url|default('https://filedn.eu/litOB0SUT8q5aLOM933djFm/Contrato%20domiciliaci%C3%B3n-Solwed.pdf') }}"
       class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener noreferrer">
        <i class="fa-solid fa-download me-1"></i>Descargar contrato
    </a>
</div>
{% endif %}

{% if has_error %}
    <div class="alert alert-{{ view.error_type|default('warning') }} d-flex align-items-center" role="alert">
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        {{ error_message }}
    </div>
{% endif %}

{% if view.count == 0 or view.cursor is empty %}
    <div class="alert alert-info d-flex align-items-center">
        <i class="fa-solid fa-info-circle me-2"></i>
        No hay dominios registrados para este cliente.
    </div>
{% else %}
    {# Dominios próximos a expirar #}
    {% if view.expiring_count > 0 %}
        <div class="alert alert-warning mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="fa-solid fa-clock me-2"></i>
                <strong>Dominios próximos a expirar</strong>
            </div>
            <p class="mb-2 mt-2">Tienes {{ view.expiring_count }} dominio(s) próximo(s) a expirar en los próximos 30 días.</p>
            {% if view.expiring_domains is not empty %}
                <ul class="mb-0 ps-4">
                    {% for domain in view.expiring_domains %}
                        <li class="small">
                            <strong>{{ domain.name }}</strong>
                            expira el
                            <code>{{ domain.expiration }}</code>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    {% endif %}

    {% if view.can_purchase_domain|default(false) %}
        {# Botón de compra de dominio #}
        <div class="mb-3">
            <button type="button" class="btn btn-success" onclick="showPurchaseDomainModal()">
                <i class="fa-solid fa-cart-plus me-2"></i>Comprar dominio
            </button>
        </div>
    {% endif %}

    {# Tabla de dominios #}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">
                        <i class="fa-solid fa-globe me-1"></i>Dominio
                    </th>
                    <th scope="col">
                        <i class="fa-solid fa-circle-notch me-1"></i>Estado
                    </th>
                    <th scope="col">
                        <i class="fa-solid fa-calendar me-1"></i>Expira
                    </th>
                    <th scope="col">
                        <i class="fa-solid fa-rotate me-1"></i>Renovación automática
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for contact in view.cursor %}
                    {% for domain in contact.domains %}
                        <tr>
                            <td>
                                <a href="https://{{ domain.name }}" target="_blank" rel="noopener noreferrer"
                                   class="text-decoration-none">
                                    <i class="fa-solid fa-arrow-up-right-from-square me-1"></i>
                                    {{ domain.name }}
                                </a>
                                {% if domain.nameservers is not empty %}
                                <br><small class="text-muted">{{ domain.nameservers|join(', ') }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% set status_lower = (domain.status ?: 'unknown')|lower %}
                                {% if status_lower == 'active' %}
                                    <span class="badge bg-success">
                                        <i class="fa-solid fa-check me-1"></i>Activo
                                    </span>
                                {% elseif status_lower in ['inactive', 'expired', 'caducado', 'suspended', 'cancelado'] %}
                                    <span class="badge bg-danger">
                                        <i class="fa-solid fa-circle-xmark me-1"></i>{{ domain.status }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fa-solid fa-circle-exclamation me-1"></i>{{ domain.status }}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if domain.expiration %}
                                    {{ domain.expiration|slice(0, 10) }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if allow_autorenew_toggle %}
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               id="autorenew-{{ loop.index }}"
                                               {{ domain.autorenew ? 'checked' : '' }}
                                               onchange="toggleAutoRenew('{{ domain.name }}', this.checked)">
                                        <label class="form-check-label" for="autorenew-{{ loop.index }}">
                                            <small>{{ domain.autorenew ? 'Sí' : 'No' }}</small>
                                        </label>
                                    </div>
                                {% else %}
                                    <div class="d-grid gap-2">
                                        <span class="badge {{ domain.autorenew ? 'bg-success' : 'bg-secondary' }} fw-bold" style="font-size: 0.75em; padding: 0.35em 0.55em;">
                                            {% if domain.autorenew %}
                                                <i class="fa-solid fa-check me-1"></i>Renovación automática activada
                                            {% else %}
                                                <i class="fa-solid fa-ban me-1"></i>Renovación automática desactivada
                                            {% endif %}
                                        </span>
                                        {% if not domain.autorenew and not view.has_signed_domiciliation|default(false) %}
                                            <small class="text-muted">
                                                Para activar la renovación automática necesitamos el contrato firmado.
                                                <a href="{{ view.autorenew_contract_url|default('https://filedn.eu/litOB0SUT8q5aLOM933djFm/Contrato%20domiciliación-Solwed.pdf') }}"
                                                   target="_blank" rel="noopener noreferrer">
                                                    Descarga aquí el documento.
                                                </a>
                                            </small>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% set nameservers = domain.nameservers ?? [] %}
                        {% set second_ns = nameservers[1] ?? null %}
{% set lock_label = domain.transfer_block ? 'Desbloquear transferencia' : 'Bloquear transferencia' %}
                        <tr class="table-light">
                            <td colspan="4" class="border-top-0">
                                <div class="d-flex flex-wrap gap-2">
                                    {# Servidor Web (NS2) - Condicional #}
                                    {% if second_ns %}
                                    <button type="button"
                                            class="btn btn-sm btn-primary"
                                            data-second-ns="{{ second_ns }}"
                                            onclick="openSecondNameserver(this)">
                                        <i class="fa-solid fa-globe me-1"></i>Servidor Web
                                    </button>
                                    {% endif %}

                                    {# Servidor Correo - Siempre visible #}
                                    <a class="btn btn-sm btn-info"
                                       href="https://serverdata.solwed-hosting.es"
                                       target="_blank"
                                       rel="noopener noreferrer">
                                        <i class="fa-solid fa-envelope me-1"></i>Servidor Correo
                                    </a>

                                    {# AuthCode #}
                                    <button type="button" class="btn btn-sm btn-warning"
                                            onclick="showAuthCode('{{ domain.name }}')">
                                        <i class="fa-solid fa-key me-1"></i>AuthCode
                                    </button>

                                    {# Renovar - Condicional #}
                                    {% if domain.renewable %}
                                    <button type="button" class="btn btn-sm btn-success"
                                            onclick="showRenewDomain('{{ domain.name }}')">
                                        <i class="fa-solid fa-rotate-right me-1"></i>Renovar
                                    </button>
                                    {% endif %}

                                    {# Bloquear/Desbloquear transferencia #}
                                    <button type="button" class="btn btn-sm btn-{{ domain.transfer_block ? 'danger' : 'success' }}"
                                            onclick="toggleTransferLock('{{ domain.name }}', {{ domain.transfer_block ? 'false' : 'true' }})">
                                        <i class="fa-solid fa-{{ domain.transfer_block ? 'lock-open' : 'lock' }} me-1"></i>{{ lock_label }}
                                    </button>

                                    {# Actualizar NS #}
                                    <button type="button" class="btn btn-sm btn-primary"
                                            onclick="showUpdateNameservers('{{ domain.name }}', '{{ domain.nameservers|join(', ') }}')">
                                        <i class="fa-solid fa-server me-1"></i>Actualizar NS
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

{% endif %}

{# Modales para las acciones #}

{# Modal: AuthCode #}
<div class="modal fade" id="authcodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid fa-key me-2"></i>Código de autorización
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="authcodeContent" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Modal: Actualizar Nameservers #}
<div class="modal fade" id="updateNsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid fa-server me-2"></i>Actualizar nameservers
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Introduce los nameservers (uno por línea). Mínimo 2, máximo 7.</p>
                <textarea class="form-control" id="nameserversInput" rows="6"
                          placeholder="ns1.example.com&#10;ns2.example.com"></textarea>
                <small class="text-muted">Debe indicar entre 2 y 7 nameservers.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="executeUpdateNameservers()">
                    <i class="fa-solid fa-save me-1"></i>Guardar cambios
                </button>
            </div>
        </div>
    </div>
</div>

{# Modal: Renovar Dominio #}
<div class="modal fade" id="renewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>Renovar dominio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fa-solid fa-exclamation-circle me-2"></i>
                    Esta acción consumirá saldo de tu cuenta DonDominio. Asegúrate de disponer de crédito suficiente.
                </div>
                <div class="mb-3">
                    <label class="form-label">Años de renovación</label>
                    <select class="form-select" id="renewYears">
                        <option value="1">1 año</option>
                        <option value="2">2 años</option>
                        <option value="3">3 años</option>
                        <option value="5">5 años</option>
                        <option value="10">10 años</option>
                    </select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="renewConfirm">
                    <label class="form-check-label" for="renewConfirm">
                        Confirmo que acepto el cargo en mi cuenta DonDominio.
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="executeRenew()">
                    <i class="fa-solid fa-rotate-right me-1"></i>Renovar ahora
                </button>
            </div>
        </div>
    </div>
</div>

{% if view.can_purchase_domain|default(false) %}
{# Modal: Comprar Dominio #}
<div class="modal fade" id="purchaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fa-solid fa-cart-plus me-2"></i>Comprar dominio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {# Paso 1: Buscar dominio #}
                <div id="searchDomainSection">
                    <div class="mb-3">
                        <label class="form-label">Nombre del dominio</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="domainToSearch"
                                   placeholder="ejemplo.com"
                                   onkeypress="if(event.key === 'Enter') checkDomainAvailability()">
                            <button class="btn btn-primary" type="button" onclick="checkDomainAvailability()">
                                <i class="fa-solid fa-search me-1"></i>Verificar disponibilidad
                            </button>
                        </div>
                        <small class="text-muted">Introduce el nombre completo del dominio (ej: midominio.com, midominio.es)</small>
                    </div>
                    <div id="availabilityResult"></div>
                </div>

                {# Paso 2: Formulario de compra #}
                <div id="purchaseFormSection" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fa-solid fa-check-circle me-2"></i>
                        <strong id="availableDomainName"></strong> está disponible para compra
                    </div>

                    {# Información de precio y saldo #}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Precio del dominio</h6>
                                    <p class="card-text fs-5" id="domainPrice">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Saldo disponible</h6>
                                    <p class="card-text fs-5" id="accountBalance">--</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Años de registro #}
                    <div class="mb-3">
                        <label class="form-label">Años de registro</label>
                        <select class="form-select" id="purchaseYears" onchange="updateTotalCost()">
                            <option value="1">1 año</option>
                            <option value="2">2 años</option>
                            <option value="3">3 años</option>
                            <option value="5">5 años</option>
                            <option value="10">10 años</option>
                        </select>
                    </div>

                    {# Coste total #}
                    <div class="alert alert-info">
                        <strong>Coste total:</strong> <span id="totalCost">--</span>
                    </div>

                    {# Datos de contacto (readonly, autocompletados) #}
                    <div class="mb-3">
                        <h6>Datos de contacto del titular</h6>
                        <p class="text-muted small">Estos datos se toman automáticamente de la ficha del cliente</p>

                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label small">Nombre/Empresa</label>
                                <input type="text" class="form-control form-control-sm" id="contactName" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small">Email</label>
                                <input type="email" class="form-control form-control-sm" id="contactEmail" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small">Teléfono</label>
                                <input type="text" class="form-control form-control-sm" id="contactPhone" readonly>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label small">NIF/CIF</label>
                                <input type="text" class="form-control form-control-sm" id="contactTaxId" readonly>
                            </div>
                        </div>
                    </div>

                    {# Advertencia y confirmación #}
                    <div class="alert alert-warning">
                        <i class="fa-solid fa-exclamation-triangle me-2"></i>
                        <strong>ATENCIÓN:</strong> Esta operación consumirá saldo de tu cuenta DonDominio.
                        Asegúrate de tener crédito suficiente antes de continuar.
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="purchaseConfirm">
                        <label class="form-check-label" for="purchaseConfirm">
                            Confirmo que acepto el cargo a mi cuenta DonDominio y que los datos son correctos
                        </label>
                    </div>

                    <button type="button" class="btn btn-success w-100" onclick="executePurchase()">
                        <i class="fa-solid fa-cart-shopping me-1"></i>Comprar dominio ahora
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Variables globales
let currentDomain = '';
{% if view.can_purchase_domain|default(false) %}
let domainToCheck = '';
let domainPricePerYear = 0;
let domainCurrency = 'EUR';
{% endif %}
let authcodeModal, updateNsModal, renewModal{% if view.can_purchase_domain|default(false) %}, purchaseModal{% endif %};

// Inicializar modales Bootstrap
document.addEventListener('DOMContentLoaded', function() {
    if (typeof bootstrap !== 'undefined') {
        authcodeModal = new bootstrap.Modal(document.getElementById('authcodeModal'));
        updateNsModal = new bootstrap.Modal(document.getElementById('updateNsModal'));
        renewModal = new bootstrap.Modal(document.getElementById('renewModal'));
        {% if view.can_purchase_domain|default(false) %}
        purchaseModal = new bootstrap.Modal(document.getElementById('purchaseModal'));
        {% endif %}
    }
});

// ========== FASE 1: SOLO LECTURA ==========

function showAuthCode(domain) {
    currentDomain = domain;
    document.getElementById('authcodeContent').innerHTML = '<div class="spinner-border text-primary" role="status"></div>';
    authcodeModal.show();

    fetchAction('get-authcode', {domain: domain}, function(data) {
        if (data.success && data.authcode) {
            let html = '<div class="alert alert-success">';
            html += '<h6>Código de autorización</h6>';
            html += '<div class="input-group">';
            html += '<input type="text" class="form-control" value="' + data.authcode + '" readonly>';
            html += '<button class="btn btn-outline-secondary" onclick="copyToClipboard(\'' + data.authcode + '\')"><i class="fa-solid fa-copy"></i></button>';
            html += '</div></div>';
            document.getElementById('authcodeContent').innerHTML = html;
        } else {
            document.getElementById('authcodeContent').innerHTML =
                '<div class="alert alert-danger">' + (data.error || 'Error al obtener AuthCode') + '</div>';
        }
    });
}

// ========== FASE 2: ACCIONES ==========

function showUpdateNameservers(domain, currentNs) {
    currentDomain = domain;
    document.getElementById('nameserversInput').value = currentNs.replace(/, /g, '\n');
    updateNsModal.show();
}

function executeUpdateNameservers() {
    const nameservers = document.getElementById('nameserversInput').value;

    if (confirm('¿Estás seguro de actualizar los nameservers? Los cambios pueden tardar hasta 48 horas en propagarse.')) {
        fetchAction('update-nameservers', {domain: currentDomain, nameservers: nameservers}, function(data) {
            if (data.success) {
                alert('✓ Nameservers actualizados correctamente');
                updateNsModal.hide();
                location.reload();
            } else {
                alert('✗ Error: ' + (data.error || 'No se pudo actualizar'));
            }
        });
    }
}

function showRenewDomain(domain) {
    currentDomain = domain;
    document.getElementById('renewConfirm').checked = false;
    renewModal.show();
}

function executeRenew() {
    if (!document.getElementById('renewConfirm').checked) {
        alert('Debes confirmar que aceptas el cargo antes de continuar');
        return;
    }

    const years = document.getElementById('renewYears').value;

    if (confirm('¿Confirmas la renovación de ' + currentDomain + ' por ' + years + ' año(s)? Se cargará el importe a tu cuenta DonDominio.')) {
        fetchAction('renew-domain', {domain: currentDomain, years: years}, function(data) {
            if (data.success) {
                alert('✓ Dominio renovado correctamente\nID Pedido: ' + (data.order_id || 'N/A') + '\nCoste: ' + data.cost + ' ' + data.currency);
                renewModal.hide();
                location.reload();
            } else {
                alert('✗ Error: ' + (data.error || 'No se pudo renovar'));
            }
        });
    }
}

{% if allow_autorenew_toggle %}
function toggleAutoRenew(domain, enable) {
    const action = enable ? 'activar' : 'desactivar';
    if (confirm('¿Confirmas ' + action + ' la renovación automática de ' + domain + '?')) {
        fetchAction('toggle-autorenew', {domain: domain, enable: enable}, function(data) {
            if (data.success) {
                alert('✓ ' + data.message);
                location.reload();
            } else {
                alert('✗ Error: ' + (data.error || 'No se pudo cambiar la configuración'));
            }
        });
    } else {
        location.reload();
    }
}
{% endif %}

function toggleTransferLock(domain, enable) {
    const action = enable ? 'bloquear' : 'desbloquear';
    if (confirm('¿Confirmas ' + action + ' la transferencia de ' + domain + '?')) {
        fetchAction('toggle-transfer-lock', {domain: domain, enable: enable}, function(data) {
            if (data.success) {
                alert('✓ ' + data.message);
                location.reload();
            } else {
                alert('✗ Error: ' + (data.error || 'No se pudo cambiar el bloqueo'));
            }
        });
    }
}

function openSecondNameserver(button) {
    if (!button) {
        return;
    }

    const ns = (button.getAttribute('data-second-ns') || '').trim();

    if (!ns) {
        alert('Este dominio no tiene configurado un segundo nameserver.');
        return;
    }

    const url = /^https?:\/\//i.test(ns) ? ns : 'https://' + ns;
    window.open(url, '_blank', 'noopener');
}

// ========== COMPRA DE DOMINIOS ==========

{% if view.can_purchase_domain|default(false) %}
function showPurchaseDomainModal() {
    // Resetear formulario
    document.getElementById('domainToSearch').value = '';
    document.getElementById('availabilityResult').innerHTML = '';
    document.getElementById('searchDomainSection').style.display = 'block';
    document.getElementById('purchaseFormSection').style.display = 'none';
    document.getElementById('purchaseConfirm').checked = false;

    purchaseModal.show();
}

function checkDomainAvailability() {
    const domain = document.getElementById('domainToSearch').value.trim();

    if (!domain) {
        alert('Por favor, introduce un nombre de dominio');
        return;
    }

    // Validar formato básico
    if (!domain.includes('.') || domain.length < 4) {
        alert('Por favor, introduce un nombre de dominio válido (ej: ejemplo.com)');
        return;
    }

    domainToCheck = domain;

    // Mostrar loading
    document.getElementById('availabilityResult').innerHTML =
        '<div class="text-center py-3"><div class="spinner-border text-primary"></div><p class="mt-2">Verificando disponibilidad...</p></div>';

    fetchAction('check-domain', {domain: domain}, function(data) {
        if (data.success) {
            if (data.available) {
                // Dominio disponible - mostrar formulario de compra
                showPurchaseForm(data);
            } else {
                // Dominio no disponible
                document.getElementById('availabilityResult').innerHTML =
                    '<div class="alert alert-danger"><i class="fa-solid fa-times-circle me-2"></i><strong>' +
                    domain + '</strong> no está disponible para registro</div>';
            }
        } else {
            document.getElementById('availabilityResult').innerHTML =
                '<div class="alert alert-danger"><i class="fa-solid fa-exclamation-triangle me-2"></i>Error: ' +
                (data.error || 'No se pudo verificar el dominio') + '</div>';
        }
    });
}

function showPurchaseForm(availabilityData) {
    // Guardar datos del dominio
    domainPricePerYear = availabilityData.price;
    domainCurrency = availabilityData.currency;

    // Ocultar búsqueda, mostrar formulario
    document.getElementById('searchDomainSection').style.display = 'none';
    document.getElementById('purchaseFormSection').style.display = 'block';

    // Rellenar datos
    document.getElementById('availableDomainName').textContent = availabilityData.domain;
    document.getElementById('domainPrice').textContent =
        domainPricePerYear.toFixed(2) + ' ' + domainCurrency + ' / año';

    // Obtener y mostrar saldo
    {% if view.account_info is defined and view.account_info is not empty %}
    document.getElementById('accountBalance').textContent =
        '{{ view.account_info.balance|number_format(2, ",", ".") }} {{ view.account_info.currency }}';
    {% else %}
    document.getElementById('accountBalance').textContent = 'No disponible';
    {% endif %}

    // Autocompletar datos de contacto desde el cliente
    {% if fsc.getModel() is defined %}
    {% set cliente = fsc.getModel() %}
    document.getElementById('contactName').value = '{{ cliente.nombre|escape("js") }}';
    document.getElementById('contactEmail').value = '{{ cliente.email|escape("js") }}';
    document.getElementById('contactPhone').value = '{{ cliente.telefono1|escape("js") }}';
    document.getElementById('contactTaxId').value = '{{ cliente.cifnif|escape("js") }}';
    {% endif %}

    // Calcular coste total inicial
    updateTotalCost();

    // Premium warning
    if (availabilityData.premium) {
        document.getElementById('availabilityResult').innerHTML =
            '<div class="alert alert-warning"><i class="fa-solid fa-star me-2"></i>Este es un dominio <strong>premium</strong>. ' +
            'El precio puede ser superior al estándar.</div>';
    }
}

function updateTotalCost() {
    const years = parseInt(document.getElementById('purchaseYears').value);
    const total = domainPricePerYear * years;
    document.getElementById('totalCost').textContent =
        total.toFixed(2) + ' ' + domainCurrency + ' (' + years + ' año' + (years > 1 ? 's' : '') + ')';
}

function executePurchase() {
    // Validar confirmación
    if (!document.getElementById('purchaseConfirm').checked) {
        alert('Debes confirmar que aceptas el cargo antes de continuar');
        return;
    }

    const years = parseInt(document.getElementById('purchaseYears').value);
    const total = (domainPricePerYear * years).toFixed(2);

    if (!confirm('¿Confirmas la compra de ' + domainToCheck + ' por ' + years + ' año(s)?\n\nSe cargará ' + total + ' ' + domainCurrency + ' a tu cuenta DonDominio.')) {
        return;
    }

    // Deshabilitar botón y mostrar loading
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Procesando compra...';

    fetchAction('purchase-domain', {domain: domainToCheck, years: years}, function(data) {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-cart-shopping me-1"></i>Comprar dominio ahora';

        if (data.success) {
            alert('✓ Dominio comprado correctamente!\n\n' +
                  'Dominio: ' + domainToCheck + '\n' +
                  'Coste: ' + data.cost + ' ' + data.currency + '\n' +
                  'ID Pedido: ' + (data.order_id || 'N/A') + '\n\n' +
                  'El dominio aparecerá en la lista en unos momentos.');
            purchaseModal.hide();
            location.reload();
        } else {
            alert('✗ Error en la compra: ' + (data.error || 'Error desconocido'));
        }
    });
}
{% endif %}

// ========== UTILIDADES ==========

function fetchAction(action, params, callback) {
    const formData = new FormData();
    formData.append('action', action);
    for (const key in params) {
        formData.append(key, params[key]);
    }

    fetch(window.location.href, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(callback)
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión');
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        alert('✓ Copiado al portapapeles');
    });
}

</script>
